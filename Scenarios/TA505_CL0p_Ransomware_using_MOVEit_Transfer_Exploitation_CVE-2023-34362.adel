title "TA505 CL0p Ransomware using MOVEit Transfer Exploitation CVE-2023-34362"
description "CL0p Ransomware by TA505: CL0p ransomware is a variant of a previously known strain called CryptoMix. In 2019, CL0p was delivered as the final payload of a phishing campaign associated with the financially motivated actor TA505. In 2020, CL0p has evolved from a ransomware delivered through malicious spam to one being used in targeted campaigns against high-profile companies. CL0p appends the .CL0p extension to the victims files. We have observed different variants using different extensions, such as .CIIp, .Cllp and .C_L_O_P. This ransomware includes various features to avoid detection. Observed CL0p samples try to kill several processes and services related to backups and security solutions. CL0p details: Operators using this ransomware, typically cxfiltratate valuable documents, before encrypting victims files. CL0p operators demand payment in exchange for the decryption keys and a promise not to publicly leak the stolen materials. After the ransomware is executed, CL0p appends the .CL0p extension to the victim's files. We have observed different variants using different extensions, such as .CIIp, .Cllp and .C_L_O_P. Different versions of the ransom note have also been observed after encryption. Depending on the variant, any of these ransom text files could drop: CL0pReadMe.txt, README_README.txt, Cl0pReadMe.txt and READ_ME_!!!.TXT.  CL0p has been linked to threat actors who have been exploiting Accellion File Transfer Appliance (FTA) vulnerabilities: CVE-2021-27101, CVE-2021-27102, CVE-2021-27103 and CVE-2021-27104. Initial TTPs: Exploit Public-Facing Application T1190, Exfiltration Over C2 Channel T1041, Spearphishing Attachment T1566.001, Code Signing T1553.002, Windows Command Shell T1059.003. Discovery TTPS: File and Directory Discovery T1083, Process Discovery T1057. Impact TTPS: Data Encrypted for Impact T1486, Inhibit System Recovery T1490, Service Stop T1489"
revision 3
author "Detecteam"
status "released"

reference "https://unit42.paloaltonetworks.com/Clop-ransomware/"
reference "https://www.proofpoint.com/us/threat-insight/post/threat-actor-profile-ta505-dridex-globeimposter"
reference "https://www.mcafee.com/blogs/other-blogs/mcafee-labs/Clop-ransomware/"
reference "https://www.splunk.com/en_us/blog/security/detecting-Clop-ransomware.html"
reference "https://www.pcrisk.com/removal-guides/14451-Clop-ransomware"
reference "https://cyberint.com/blog/techtalks/clop-ransomware/"
reference "https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023"
reference "https://www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response"
reference "https://www.trustedsec.com/blog/critical-vulnerability-in-progress-moveit-transfer-technical-analysis-and-recommendations/"
reference "https://www.mandiant.com/resources/blog/zero-day-moveit-data-theft"
reference "https://www.rapid7.com/blog/post/2023/06/01/rapid7-observed-exploitation-of-critical-moveit-transfer-vulnerability/"
reference "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-34362"
reference "https://gist.github.com/JohnHammond/44ce8556f798b7f6a7574148b679c643"
reference "https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-158a"

tag "threat-group=Clop"
tag "category=ransomware"
tag "mitre-attack=T1041"
tag "mitre-attack=T1057"
tag "mitre-attack=T1059.003"
tag "mitre-attack=T1083"
tag "mitre-attack=T1086"
tag "mitre-attack=T1210"
tag "mitre-attack=T1489"
tag "mitre-attack=T1490"
tag "mitre-attack=T1553.002"
tag "mitre-attack=T1566.001"
tag "vulnerability=CVE-2021-27101"
tag "vulnerability=CVE-2021-27102"
tag "vulnerability=CVE-2021-27103"
tag "vulnerability=CVE-2021-27104"
tag "vulnerability=CVE-2023-34362"

    # Accellion File Transfer Appliance (FTA) vulnerabilities

section start "Start" {}
    $file.name_array = ["app_web_xlji1wtn.dll", "app_web_c1tp5zym.dll", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "h2.aspx", "human2.aspx", "UNAVAILABLE", "human2.aspx", "human2.aspx", "human2.aspx", "donotuse_human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "human2.aspx", "%temp%7zipsfx.000zoom.exe", "c:usersuserappdatalocaltemp7zipsfx.000anetdiag.dll", "7zsfxmod_x86.exe", "larabqfa.exe", "dnsjujahur.exe", "uhfdkuswkfkeduui.exe"]
    $file.size_array = ["12288", "12288", "6249", "6249", "6249", "6249", "6428", "7448", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6249", "6279", "6249", "6249"]
    $file.hash.md5_array = ["2387BE2AFE2250C20D4E7A8C185BE8D9", "2CB7915A13D147E9AF2BA5959958C31A", "250454DC24258B5825AC36F042D9CB71", "F05A4095650DAA1F9B7F72B8DED21A49", "3A0342417E8588EF7738352341E25830", "83500E433A0D63B993B91A94D9D45BCD", "7D7349E51A9BDCDD8B5DAEEEFE6772B5", "DDD95F1C76A1D50B997B2E64274F386A", "9F3C306DABC3F349B343251F4443412C", "B69E23CD45C8AC71652737EF44E15A34", "96D467FD9663CF2E5572F8529E54F13E", "EEA4D43F9E3700EBCD61405776EB249A", "D71A6B5AE3D89DC33CBBB6877E493D52", "00C6BCE35C40CE1601AA06C4E808C0F1", "04B474E8DB353D368E2D791BA5DEE6D6", "317552CAC7035E35F7BDFC2162DFD29C", "8D88E451E39506AE258F3AA99DA8DB9A", "C2DB1091EB7BAC28461877F736D86D83", "538D6E172D18D4CEBEAC211873779BA5", "45685C190C91EBE0966E8A0AECA31280", "B52E56BFC03878CC5CB9EAE9D3896808", "AF136505D384C9A89635B365E55B7FA3", "B1BDAD086567EFD202BABF56EAC17E1D", "BF7C1DD613101C0A95027249A5FCB759", "11EADCF3F1BC9B0ED6994C3EDE299CE8", "7D5E5537C5346D764F067F66CCA426BA", "359A1141A79480555AA996FD6D9E4AF1", "67FCA3E84490DFDDDF72E9BA558B589A", "A85299F78AB5DD05E7F0F11ECEA165EA", "E9A5F0C7656329CED63D4C8742DA51B4", "911230B5DCA1C43F6D22E65C66B0F6B1", "8CD6C75E6160B90DE2A52C967B3D4846", "DFA8EC974DDDF5BCC888549E60D6530F", "E9B3BA7B4F37FE4A9804136801ABB8B0", "65FB9572171B903AA31A325F550D8778", "EE1CCB6A0E38BF95E44B73C3C46268C5", "DBECFE9D5421D319534E0BFA5A6AC162", "B7FED593E8EB3646F876367B56725E6C"]
    $file.hash.sha256_array = ["F2F08E4F108AAFFAADC3D11BAD24ABDD625A77E0EE9674C4541B562C78415765", "EB9F5CBE71F9658D38FB4A7AA101AD40534C4C93EE73EF5F6886D89159B0E2C2", "A8569C78AF187D603EECDC5FAEC860458919349EEF51091893B705F466340ECD", "367FA8B3BAFD99CB0FA5EFC23FFB91D0DAEF6E33BE1378EE1EB525FF9DDD9095", "ED0C3E75B7AC2587A5892CA951707B4E0DD9C8B18AAF8590C24720D73AA6B90C", "CEC425B3383890B63F5022054C396F6D510FAE436041ADD935CD6CE42033F621", "B5EF11D04604C9145E4FE1BEDAEB52F2C2345703D52115A5BF11EA56D7FB6B03", "A8F6C1CCBA662A908EF7B0CB3CC59C2D1C9E2CBBE1866937DA81C4C616E68986", "98A30C7251CF622BD4ABCE92AB527C3F233B817A57519C2DD2BF8E3D3CCB7DB8", "7C39499DD3B0B283B242F7B7996205A9B3CF8BD5C943EF6766992204D46EC5F1", "769F77AACE5EED4717C7D3142989B53BD5BAC9297A6E11B2C588C3989B397E6B", "58CCFB603CDC4D305FDDD52B84AD3F58FF554F1AF4D7EF164007CB8438976166", "2CCF7E42AFD3F6BF845865C74B2E01E2046E541BB633D037B05BD1CDB296FA59", "1826268249E1EA58275328102A5A8D158D36B4FD312009E4A2526F0BFBC30DE2", "110E301D3B5019177728010202C8096824829C0B11BB0DC0BFF55547EAD18286", "0B3220B11698B1436D1D866AC07CC90018E59884E91A8CB71EF8924309F1E0E9", "BDD4FA8E97E5E6EAAAC8D6178F1CF4C324B9C59FC276FD6B368E811B327CCF8B", "3C0DBDA8A5500367C22CA224919BFC87D725D890756222C8066933286F26494C", "93137272F3654D56B9CE63BEC2E40DD816C82FB6BAD9985BED477F17999A47DB", "C58C2C2EA608C83FAD9326055A8271D47D8246DC9CB401E420C0971C67E19CBF", "A1269294254E958E0E58FC0FE887EBBC4201D5C266557F09C3F37542BD6D53D7", "F0D85B65B9F6942C75271209138AB24A73DA29A06BC6CC4FAEDDCB825058C09D", "CF23EA0D63B4C4C348865CEFD70C35727EA8C82BA86D56635E488D816E60EA45", "5B566DE1AA4B2F79F579CDAC6283B33E98FDC8C1CFA6211A787F8156848D67FF", "D477EC94E522B8D741F46B2C00291DA05C72D21C359244CCB1C211C12B635899", "B9A0BAF82FEB08E42FA6CA53E9EC379E79FBE8362A7DAC6150EB39C2D33D94AD", "38E69F4A6D2E81F28ED2DC6DF0DAF31E73EA365BD2CFC90EBC31441404CCA264", "3A977446ED70B02864EF8CFA3135D8B134C93EF868A4CC0AA5D3C2A74545725B", "C77438E8657518221613FBCE451C664A75F05BEEA2184A3AE67F30EA71D34F37", "0EA05169D111415903A1098110C34CDBBD390C23016CD4E179DD9EF507104495", "348E435196DD795E1EC31169BD111C7EC964E5A6AB525A562B17F10DE0AB031D", "DAAA102D82550F97642887514093C98CCD51735E025995C2CC14718330A856F4", "4359AEAD416B1B2DF8AD9E53C497806403A2253B7E13C03317FC08AD3B0B95BF", "EA433739FB708F5D25C937925E499C8D2228BF245653EE89A6F3D26A5FD00B7A", "E8012A15B6F6B404A33F293205B602ECE486D01337B8B3EC331CD99CCADB562E", "9E89D9F045664996067A05610EA2B0AD4F7F502F73D84321FB07861348FDC24A", "2413B5D0750C23B07999EC33A5B4930BE224B661AAF290A0118DB803F31ACBC5", "B1C299A9FE6076F370178DE7B808F36135DF16C4E438EF6453A39565FF2EC272", "9D1723777DE67BC7E11678DB800D2A32DE3BCD6C40A629CD165E3F7BBACE8EAD", "702421BCEE1785D93271D311F0203DA34CC936317E299575B06503945A6EA1E0", "6015FED13C5510BBB89B0A5302C8B95A5B811982FF6DE9930725C4630EC4011D", "FE5F8388CCEA7C548D587D1E2843921C038A9F4DDAD3CB03F3AA8A45C29C6A2F", "48367D94CCB4411F15D7EF9C455C92125F3AD812F2363C4D2E949CE1B615429A", "D49CF23D83B2743C573BA383BF6F3C28DA41AC5F745CDE41EF8CD1344528C195", "C56BCB513248885673645FF1DF44D3661A75CFACDCE485535DA898AA9BA320D4", "1285AA7E6EE729BE808C46C069E30A9EE9CE34287151076BA81A0BEA0508FF7E", "2C8D58F439C708C28AC4AD4A0E9F93046CF076FC6E5AB1088E8943C0909ACBC4", "D5BBCAA0C3EEEA17F12A5CC3DBCAFFFF423D00562ACB694561841BCFE984A3B7", "0E3A14638456F4451FE8D76FDC04E591FBA942C2F16DA31857CA66293A58A4C3", "C9B874D54C18E895FACE055EEB6FAA2DA7965A336D70303D0BD6047BEC27A29D", "FF8C8C8BFBA5F2BA2F8003255949678DF209DBFF95E16F2F3C338CFA0FD1B885"]
    $destination.domain_array = ["zoom.voyage", "connectzoomdownload.com", "qweastradoc.com", "jirostrogud.com", "hiperfdhaus.com", "5.188.206.76:8000", "198.199.74.207:1234", "connectzoomdownload.com", "connectzoomdownload.com", "guerdofest.com", "guerdofest.com", "zoom.voyage", "qweastradoc.com", "qweastradoc.com", "jirostrogud.com", "hiperfdhaus.com"]
    $url.path_array = ["/download/Zoom.exe", "/download/ZoomInstaller.exe", "/se1.dll", "/update.jsp", "/download/ZoomInstaller.exe", "/gate.php", "/gate.php"]

section global_variables "__hidden__" {
    $computer.name="beachhead"
    $user.name="johndoe"
    $cidr_range="192.168.1.0/24"
    $server.name="server"
    $server.ip="192.168.1.254"
    $admin_id="administrator"
    $admin_password=random.string(8)
    

    $event_platform="Win"

    $CL0p_agents=[
        "C:\Users\Public\CL0p.exe",
        "C:\Users\Public\CL0p_mlwr_d.exe"
    ]

    $CL0p_notes=[
        "CL0pReadMe.txt",
        "README_README.txt"
    ]

    $CL0p_crypt_extensions=[
        ".CL0p",
        ".Cllp",
        ".CLOP",
        ".ClOP",
        ".C_L_O_P"
    ]

    $files_extension=[
        ".jpg",
        ".gif",
        ".bmp",
        ".jpeg",
        ".ps1",
        ".ini",
        ".db",
        ".doc",
        ".docx",
        ".png",
        ".pdf",
        ".ppt",
        ".pptx",
        ".chm",
        ".log",
        ".js",
        ".zip",
        ".rar",
        ".7z",
        ".vbs",
        ".cmd",
        ".xls",
        ".xlsx"
    ]

    $listofunits=[
        "c",
        "d",
        "e",
        "f",
        "g",
        "h"
    ]

    $CL0pReadMe.txt="""Your network has been penetrated.
All files on each host in the network have been encrypted with a strong algorithm. Backups were either encrypted or deleted or backup disks were formatted.
Shadow copies also removed, so F8 or any other methods may damage encrypted data but not recover We exclusively have decryption software for your situation
No decryption software is available in the public. DO NOT RESET OR SHUTDOWN files may be damaged.
DO NOT RENAME OR MOVE the encrypted and readme files.
DO NOT DELETE readme files.
This may lead to the impossibility of recovery of the certain files.
Photorec, RannohDecryptor etc. repair tools are useless and can destroy your files irreversibly. If you want to restore your files write to emails (contacts are at the bottom of the sheet) and
(Less than 5 Mb each, non-archived and your files should not contain valuable information
(Databases, backups, large excel sheets, etc.)).
You will receive decrypted sales and our conditions how to get the decoder.
Attention!!!
Your warranty decrypted samples. Do not rename encrypted files.
Do not try to decrypt your data using third party software. We don't need your files and your information.
But after 2 weeks all your files and keys will be deleted automatically.
Contact emails:
servicedigilogos@protonmail. com
or
managersmaers@tutanota. com
The final price depends on how fast you write to us.
CL0p"""

    $computer.name = "moveittransfer"
    $user.name = "moveitsvc"
    $cidr_range = "192.168.1.0/24"
    $server.name = "moveittransfer"
    $server.ip = "192.168.1.254"
    $admin_id = "administrator"
    $admin_password = random.string(8)
    $event_platform = "Win"

    $moveit_server = $server.ip
    $exploit_ports = [
        443,
        80
    ]

    $versionX = random.int(3,5)
    $versionY = random.int(0,15)
    $versionZ = random.int(1,30319)
    $moveitWinFrameWorkVersion = "v${versionX}.${versionY}.${versionZ}"
    $files_affected = [
        "human2.aspx", # This ASPX file stages a SQL database account to be used for further access.
        "*.cmdline",
        "*.dll",
        "*.human2"
    ]

    $http_attack_headers = [
        "X-siLock-Comment",
        "X-siLock-Step1",
        "X-siLock-Step2",
        "X-siLock-Step3"
    ]

    $attack_source_infra = [
        "104.194.222.107",
        "138.197.152.201",
        "146.0.77.141",
        "146.0.77.155",
        "146.0.77.183",
        "162.244.34.26",
        "162.244.35.6",
        "179.60.150.143",
        "185.104.194.156",
        "185.104.194.24",
        "185.104.194.40",
        "185.117.88.17",
        "185.162.128.75",
        "185.174.100.215",
        "185.174.100.250",
        "185.181.229.240",
        "185.181.229.73",
        "185.183.32.122",
        "185.185.50.172",
        "188.241.58.244",
        "193.169.245.79",
        "194.33.40.103",
        "194.33.40.104",
        "194.33.40.164",
        "206.221.182.106",
        "209.127.116.122",
        "209.127.4.22",
        "209.97.137.33",
        "45.227.253.133",
        "45.227.253.147",
        "45.227.253.50",
        "45.227.253.6",
        "45.227.253.82",
        "45.56.165.248",
        "5.149.248.68",
        "5.149.250.74",
        "5.149.250.92",
        "5.188.86.114",
        "5.188.86.250",
        "5.188.87.194",
        "5.188.87.226",
        "5.188.87.27",
        "5.34.180.205",
        "62.112.11.57",
        "62.182.82.19",
        "62.182.85.234",
        "66.85.26.215",
        "66.85.26.234",
        "66.85.26.248",
        "79.141.160.78",
        "79.141.160.83",
        "84.234.96.31",
        "89.39.104.118",
        "89.39.105.108",
        "91.202.4.76",
        "91.222.174.95",
        "91.229.76.187",
        "93.190.142.131"
    ]
    $sha256_hashes = [ 
        "0ea05169d111415903a1098110c34cdbbd390c23016cd4e179dd9ef507104495",
        "2413b5d0750c23b07999ec33a5b4930be224b661aaf290a0118db803f31acbc5",
        "348e435196dd795e1ec31169bd111c7ec964e5a6ab525a562b17f10de0ab031d",
        "387cee566aedbafa8c114ed1c6b98d8b9b65e9f178cf2f6ae2f5ac441082747a",
        "3a977446ed70b02864ef8cfa3135d8b134c93ef868a4cc0aa5d3c2a74545725b",
        "3ab73ea9aebf271e5f3ed701286701d0be688bf7ad4fb276cb4fbe35c8af8409",
        "4359aead416b1b2df8ad9e53c497806403a2253b7e13c03317fc08ad3b0b95bf",
        "48367d94ccb4411f15d7ef9c455c92125f3ad812f2363c4d2e949ce1b615429a",
        "5b566de1aa4b2f79f579cdac6283b33e98fdc8c1cfa6211a787f8156848d67ff",
        "6015fed13c5510bbb89b0a5302c8b95a5b811982ff6de9930725c4630ec4011d",
        "702421bcee1785d93271d311f0203da34cc936317e299575b06503945a6ea1e0",
        "9d1723777de67bc7e11678db800d2a32de3bcd6c40a629cd165e3f7bbace8ead",
        "9e89d9f045664996067a05610ea2b0ad4f7f502f73d84321fb07861348fdc24a",
        "a1269294254e958e0e58fc0fe887ebbc4201d5c266557f09c3f37542bd6d53d7",
        "b1c299a9fe6076f370178de7b808f36135df16c4e438ef6453a39565ff2ec272",
        "c56bcb513248885673645ff1df44d3661a75cfacdce485535da898aa9ba320d4",
        "c77438e8657518221613fbce451c664a75f05beea2184a3ae67f30ea71d34f37",
        "cf23ea0d63b4c4c348865cefd70c35727ea8c82ba86d56635e488d816e60ea45",
        "d477ec94e522b8d741f46b2c00291da05c72d21c359244ccb1c211c12b635899",
        "d49cf23d83b2743c573ba383bf6f3c28da41ac5f745cde41ef8cd1344528c195",
        "daaa102d82550f97642887514093c98ccd51735e025995c2cc14718330a856f4",
        "e8012a15b6f6b404a33f293205b602ece486d01337b8b3ec331cd99ccadb562e",
        "ea433739fb708f5d25c937925e499c8d2228bf245653ee89a6f3d26a5fd00b7a",
        "f0d85b65b9f6942c75271209138ab24a73da29a06bc6cc4faeddcb825058c09d",
        "fe5f8388ccea7c548d587d1e2843921c038a9f4ddad3cb03f3aa8a45c29c6a2f"
    ]

    # MOVEit Attack Sources
    $attack_cidr_infra = [
        "5.252.189.0/24",
        "5.252.190.0/24",
        "5.252.191.0/24",
        "5.252.192.0/24",
        "5.252.193.0/24",
        "5.252.194.0/24",
        "5.252.195.0/24"
    ]

    $randomInitIPAttack = random($attack_source_infra)
    $randomSourceIPAttack = random($attack_source_infra)
    $randomSourceIPAttack2 = random($attack_source_infra)
    $randomSourceIPAttack3 = random($attack_source_infra)
    $randomSourceIPAttack4 = random($attack_source_infra)
    # moveitisapi.dll is used to perform SQL injection when requested with specific headers
    # guestaccess.aspx is used to prepare a session and extract CSRF tokens and other field values to perform further actions
    # human2.aspx is used as backdoor, which is allegedly uploaded during the attack, allows the attacker to do all malicious acts.
    $iss_attacks_chain_links = [
        "GET / - 443 - ${randomInitIPAttack} user-agent - 200",
        "POST /guestaccess.aspx - 443 - ${randomSourceIPAttack} user-agent - 200",
        "POST /api/v1/token - 443 - ${randomSourceIPAttack} user-agent - 200",
        "GET /api/v1/folders - 443 - ${randomSourceIPAttack} user-agent - 200",
        "POST /api/v1/folders/605824912/files uploadType=resumable 443 - ${randomSourceIPAttack} user-agent - 200",
        # "POST /machine2.aspx - 80 - ::1 CWinInetHTTPClient - 200",
        "POST /machine2.aspx - 80 - 0.0.0.0 CWinInetHTTPClient - 200",
        "POST /moveitisapi/moveitisapi.dll action=m2 443 - ${randomSourceIPAttack} user-agent - 200",
        "POST /guestaccess.aspx - 443 - ${randomSourceIPAttack2} user-agent - 200",
        "PUT /api/v1/folders/605824912/files uploadType=resumable&fileId=963061209 443 - ${randomSourceIPAttack2} user-agent - 500",
        # "POST /machine2.aspx - 80 - ::1 CWinInetHTTPClient - 200",
        "POST /machine2.aspx - 80 - 0.0.0.0 CWinInetHTTPClient - 200",
        "POST /moveitisapi/moveitisapi.dll action=m2 443 - ${randomSourceIPAttack2} user-agent - 200",
        "POST /guestaccess.aspx - 443 - ${randomSourceIPAttack3} user-agent - 200",
        "GET /human2.aspx - 443 - ${randomSourceIPAttack4} user-agent - 404"
    ]
}

    $process.parent.command_line = "cmd.exe"

tactic "Initial Access"
section http_request_link_attack "MOVEit Transfer CVE-2023-34362 Exploit using Internet Information Server (IIS)" {

    tag "mitre-attack=T1190"

    loop $iss_attacks_chain_links as $therequest {
        $http_request_values = string.split($therequest," ")
        $http_request_method = $http_request_values[1]
        $http_request_path = $http_request_values[2]
        $http_request_port = $http_request_values[4]
        $http_request_sourceip = $http_request_values[6]
        $http_request_code = $http_request_values[9]
        
        step http_request_link_attack {
            $destination.ip = $moveit_server
            $http.request.method = $http_request_method
            $http.request.headers = {"xx-silock-transaction": "folder_add_by_path", "X-siLock-Transaction": "session_setvars"}
            $url.path = $http_request_path
            $destination.port = $http_request_port
            $source.ip = $http_request_sourceip
            $http.response.status = $http_request_code
            run HTTPConnection
        }
    }
}

tactic "Execution"
section files_dropped "Files Dropped by MOVEit exploitation" {
    $moveitInstallPath = "C:\\MOVEitTransfer" 
    
    $moveit_webshell_filename = "human2.aspx"
    $moveit_webshell_folder = "${moveitInstallPath}\\wwwroot"

    $random_folder1 = random.hexstring(8)
    $random_folder2 = random.hexstring(8)
    $random_filename = random.string(8)
        
    $compiled_human2_filename = "App_web_${random_filename}.dll"
    $compiled_human2_folder = "C:\\Windows\\Microsoft.net\\Framework64\\v4.0.30319\\Temporary\\ ASP.NET\\ Files\\root\\${random_folder1}\\${random_folder2}" 

    step create_human2_aspx_file {
        #$file.name = "human2.aspx"
        #$file.path = "${moveitInstallPath}\\wwwroot\\${file.name}"
        $file.name = $moveit_webshell_filename
        $file.path = "${moveit_webshell_folder}\\${file.name}"
        action File.Create
    }
}

tactic "Persistence"
section compile_persistence "Compile aspx file for persistence" {

    step human2_compiler {
        $process.parent.command_line = "w3wp.exe"
        $process.command_line = "csc.exe /noconfig -out:${compiled_human2_folder}\\${compiled_human2_filename} ${moveit_webshell_folder}\\${moveit_webshell_filename}"
        
        action Process.Start
    }
    
    sleep 4

    step pre_compiled_human2_aspx_drop {
        $file.name = $compiled_human2_filename
        $file.path = "${compiled_human2_folder}\\${file.name}"
        action File.Create
    }
}

section create_cmd_files "Create cmdline files" {

    $randomFolderName = ""
    loop 5 {
        $randomFolderName = random.string(10)
        $randomFileName = random.string(8)
        step random_cmdline_files_created {
            $file.directory = """${moveitInstallPath}\wwwroot${randomFolderName}"""
            $file.name = "${randomFileName}.cmdline"
            action File.Create
        }

        $randomFolderStr = random.string(10)
        $randomFolderName = """\${randomFolderStr}"""

        step random_cmdline_backupfiles {
            $file.directory = """C:\Windows\TEMP${randomFolderName}"""
            $file.name = "${randomFileName}.cmdline"
            action File.Create
        }
    }
}


tactic "Defense Evasion"
section create_log_file "Create EVTX logs file" {
    # MOVEit Win EVTX logs file is created to record all actions
    # What was exfiltrated from compromised MOVEit customer environments
    step moveit_new_EVTX_log_file {
        $file.directory = """C:\Windows\System32\winevt\Logs"""
        $file.name = "MOVEit.evtx"
        action File.Create
    }
}

tactic "Exfiltration"
section moveit_exfil "MoveIT exfiltration" {
    # When human2.aspx is created starts the request and expansion
    # Requests to human2.aspx
    # A few attackers are now joining the party
    $random_password = random.string(10)
    loop 5 {
        $source.ip = random($attack_source_infra)
        loop $http_attack_headers as $http_ico_header {
            $folder_id = random.string(5)
            $file_id = word.generate()

            step http_requests_to_human2 {
                $random_leaked_data = random.string(16)
                $destination.ip = $moveit_server
                $http.request.method = "GET"
                $url.path = "/${moveit_webshell_filename}"
                $destination.port = 443
                $http.request.headers = {
                    "X-siLock-Comment": $random_password,
                    "X-siLock-Step1": "-1",
                    "X-siLock-Step2": $folder_id,
                    "X-siLock-Step3": $file_id
                }
                run HTTPConnection
            }
        }
    }    
}


# --- now we start with phishing

tactic "Initial Access"
section phishing_document "Phishing Document Received" {
    tag "mitre-attack=T1566"
    
    reference "https://www.proofpoint.com/us/threat-insight/post/ta505-distributes-new-sdbbot-remote-access-trojan-get2-downloader"
    step email_received   {
        $source.ip = random($attack_source_infra)
        $email.from.address = "gagnondani225@gmail.com"                                           
        $email.to.address = "mick@nomatac.com"                                            
        $email.subject = "HPE INV-02 - Invoice and Documents"                                                    
        $email.content = """Please find the attached invoice 02 documents.

Thanks & Regards,
Hari
"""                                               
                                                                                 
        action Email.Received 
    }

    sleep 60

tactic "Execution"
    step open_attached_pdf {
        $process.parent.command_line = """C:\Program Files\Microsoft Office\root\Office19\Outlook.exe"""
        $file.name = "HPE_S_HP-Inv_02.xls"
        $process.command_line = """C:\Program Files (x86)\Microsoft Office\root\Office19\EXCEL.EXE ${file.name}"""
    
        action Process.Start
    }
}    

tactic "Execution"
section macro_download_and_execution "Download and Execution from Excel macro" {
    tag "mitre-attack=T1059"

    step executing_macro_http_download {
    $destination.domain = "windows-update-02-en.com"
    $destination.ip = random($attack_source_infra)
    $http.request.method = "POST"
    $url.path = """/rs&D=eAIBfmt&U=kuBRNdQlU&OS=6.1&PR=EXCEL.EXE|KMS+Server+Service.exe|"""
    $destination.port = 443
    $source.ip = $server.ip
    $http.response.content = """https://office365-en-gb.com/razda/affs; -fdsjhf34rffwew|https://office365-en-gb.com/razda/clsdd"""
    run HTTPConnection
    }
# Behavior from 1285AA7E6EE729BE808C46C069E30A9EE9CE34287151076BA81A0BEA0508FF7E
    step process {
        $process.command_line = """%SAMPLEPATH%\1285aa7e6ee729be808c46c069e30a9ee9ce34287151076ba81a0bea0508ff7e.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\rundll32.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\wuapihost.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\logman.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -c rundll32.exe C:\Users\${user.name}\DOWNLO~1\ANetDiag.dll, ChkdskExs"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\system32\rundll32.exe C:\Users\${user.name}\DOWNLO~1\ANetDiag.dll ChkdskExs"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\rundll32.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7ZipSfx.000\ZoomInstaller.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zS0BB57701\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\dllhost.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Roaming\Zoom\bin\Zoom.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\SysWOW64\wbem\WmiPrvSE.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\wuapihost.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%SAMPLEPATH%\7ZSfxMod_x86.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zS0662AE11\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zS83936621\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zS07362011\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zSCBF12821\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zSC0C4A301\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zSC2607121\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """%USERPROFILE%\AppData\Local\Temp\7zS0EFB1B31\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Users\${user.name}\AppData\Local\Temp\7ZipSfx.000\Zoom.exe /qn"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -c rundll32.exe C:\Users\${user.name}\AppData\Local\Temp\7ZipSfx.000\ANetDiag.dll, ChkdskExs"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\system32\rundll32.exe C:\Users\${user.name}\AppData\Local\Temp\7ZipSfx.000\ANetDiag.dll ChkdskExs"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Users\${user.name}\AppData\Local\Temp\7ZipSfx.000\ZoomInstaller.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """.\Installer.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Users\${user.name}\AppData\Local\Temp\7zS0DC2DEF3\Installer.exe /addfwexception --bin_home=C:\Users\${user.name}\AppData\Roaming\Zoom\bin"""
        action Process.Start
    }

}

tactic "Command and Control"
section sdbot_installation_and_run "SDBot Command and Control" {
    tag "mitre-attack=S0461"
    
    step self_replication {
        $process.command_line = "sdbox.exe"
        $file.name = "C:\\Windows\\System32\\DESKTOP.EXE"
        action File.Create
    }
    
    step registry_create {
        $registry.path = """HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\desktop"""
        $registry.value = "C:\\Windows\\System32\\desktop.exe"
        action Windows.Registry.Create
    }
    
    $irc_server = ["knix-irc.hopto.org", "irc.knix.25u.com", "knix-irc2.hopto.org", "knix.afraid.org"]
    step irc_communication {
        $destination.port = 6667
        $destination.domain = random($irc_server)
        $irc.communication = {
        "NICK M|1|2187835|ubuntu": " ",
        "USER K localhost localhost :2022": "PING :C3CC76F6",
        "PONG :C3CC76F6": " ",
        "NOPE1": ":giraffe.su 001 M|1|2187835|ubuntu :",
        "NOPE2": ":giraffe.su 002 M|1|2187835|ubuntu :",
        "NOPE3": ":giraffe.su 003 M|1|2187835|ubuntu :",
        "NOPE4": ":giraffe.su 004 M|1|2187835|ubuntu",
        "NOPE5": ":giraffe.su 422 M|1|2187835|ubuntu :MOTD File is missing",
        "MODE M|1|2187835|ubuntu -xi": ":M|1|2187835|ubuntu!Kkdfsljq123k NICK :IN|M|1|2187835|ubuntu",
        "JOIN #virtualz :999": ":IN|IN|M|1|2187835|ubuntu!Kkdfsljq123k JOIN :#virtualz",
        "JOIN #scanlog :999": ":IN|IN|M|1|2187835|ubuntu!Kkdfsljq123k JOIN :#scanlog"
        }
        run IRCCommunication
    }
    
}

$remote_domains = ["connectzoomdownload.com", "guerdofest.com", "zoom.voyage"]
$remote_domains_uri = {"connectzoomdownload.com": "/download/ZoomInstaller.exe",
		       "guerdofest.com": "/gate.php", "zoom.voyage": " "}

section remote_access_behavior "remote access behavior" {

    loop $remote_domains as $destination.domain {
        step fqdn {
            run DNSQuery
        }

	$uri.path = $remote_domains_uri[$destination.domain]
	if ($uri.path != " ") {
            step url {
                $url.path = $remote_domains_uri[$destination.domain]
                run HTTPConnection
            }
	    }
    }

}

## Truebot
section run_truebot  "Run Truebot" {
    step cmd_injection {
        tag "mitre-attack=T1055"
        $process.parent.command_line = "C:\\Windows\\System32\\cmd.exe"
        $process.command_line = "beacon.dll"
        $StartModule = "beacon.dll"
        action Process.Thread.Inject
    }
    
    step schedule_service {
        $service.name = "r2"
        $service.data = """$j='{8D81676C-7F63-8F81-676E-666B6C67818D}';([Text.Encoding]::UTF8.GetString((gp ('hklm:\\software\\2\\clsid\\'+$j+'\\typelib')).$j))"""
        action Service.Install
    }
    # Enriched from hash 0e3a14638456f4451fe8d76fdc04e591fba942c2f16da31857ca66293a58a4c3
    # Behavior from 0e3a14638456f4451fe8d76fdc04e591fba942c2f16da31857ca66293a58a4c3
    step process {
        $process.command_line = """C:\windows\system32\rundll32.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\SYSTEM32\cmd.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """c:\windows\syswow64\rundll32.exe"""
        action Process.Start
    }

    step process {
        $process.command_line = """C:\Windows\system32\rundll32.exe"""
        action Process.Start
    }

}

tactic "Lateral Movement"
section exec_impacket "Execute IMPacket" {
   tag "mitre-attack=T1553"
    $commands = [
        """cmd.exe /Q /c cd \ 1> \\127.0.0.1\ADMINS\TEMP 2>&1""",
        """cmd.exe /Q /c quser 1> \\127.0.0.1\ADMINS\TEMP 2>&1"""
    ]
    loop $commands as $command {
        step lateral_movement_and_discovery {
            $process.command_line = $command
            action Process.Start
        }
    }
    
}

tactic "Discovery"
section discovery "cmd discovery" {
    $commands = [
        "cmd.exe /C nltest /dclist:",
       "cmd.exe /C net group 'Domain Computers' /domain",
       "cmd.exe /C nltest /DOMAIN TRUSTS",
       "cmd.exe /C time"
   ]
   loop $commands as $command {
       step discovery_commands {
           $process.command_line = $command
           action Process.Start
       }
   }
}

section rdp_logins {
   tag "mitre-attack=T1563.002"
   $rdp_server = ["192.168.1.23", "10.23.54.1"] 
   loop $rdp_server as $destination.ip {
        step rdp_login {
            $user.name = "admin"
            action RDP.LoginSuccess
        }
   }
}

tactic "Impact"
section delete_all_volume_shadows "deleting and resize the shadows storage" {
    tag "mitre-attack=T1047"

    step delete_volume_shadows { 
        $process.parent.command_line="vssadmin.exe"
        $process.command_line="""vssadmin.exe Delete Shadows /all /quiet"""
        action Process.Start
    }
    
    sleep 10

    loop $listofunits as $diskunit {
        step resize_shadowstorage {
            $process.parent.command_line="cmd.exe"
            $process.command_line="""vssadmin.exe resize shadowstorage /for=${diskunit}: /on=${diskunit}: /maxsize=401MB"""
            action Process.Start
        }
        sleep 0.5
        
        step unbounded_shadowstorage {
            $process.parent.command_line="cmd.exe"
            $process.command_line="""vssadmin.exe resize shadowstorage /for=${diskunit}: /on=${diskunit}: /maxsize=unbounded"""
            action Process.Start
        }
        
        sleep 0.75
    }
}

section disable_recovery "Disable recovery" {
    tag "mitre-attack=T1490"

    step disable_recovery_notifications { 
        $process.parent.command_line="cmd.exe"
        $process.command_line="""bcdedit.exe /set {default} bootstatuspolicy ignoreallfailures"""
        action Process.Start
    }
    
    sleep 5

    step disable_system_recovery_features {
        $process.parent.command_line="cmd.exe"
        $process.command_line="""bcdedit.exe /set {default} recoveryenabled No"""
        action Process.Start
    }
    
    sleep 2
}

section delete_shadows_storage "Delete Shadows Storage" {
    step delete_all_volume_shadow_copies_2nd { 
        $process.parent.command_line="cmd.exe"
        $process.command_line="""vssadmin.exe Delete Shadows /all /quiet"""
        action Process.Start
    }
    
    sleep 3
}

section stop_processes "Stop Processes" {

    $total_process_stopped=random.int(5,20)
    
    $bat_stop_commands=[
        """net stop SQLAgent$SYSTEM_BGC /y""",
        """net stop "Sophos Device Control Service" /y""",
        """net stop macmnsvc /y""",
        """net stop SQLAgent$ECWDB2 /y""",
        """net stop "Zoolz 2 Service" /y""",
        """net stop McTaskManager /y""",
        """net stop "Sophos AutoUpdate Service" /y""",
        """net stop "Sophos System Protection Service" /y""",
        """net stop EraserSvc11710 /y""",
        """net stop PDVFSService /y""",
        """net stop SQLAgent$PROFXENGAGEMENT /y""",
        """net stop SAVService /y""",
        """net stop MSSQLFDLauncher$TPSAMA /y""",
        """net stop EPSecurityService /y""",
        """net stop SQLAgent$SOPHOS /y""",
        """net stop "Symantec System Recovery" /y""",
        """net stop Antivirus /y""",
        """net stop SstpSvc /y""",
        """net stop MSOLAP$SQL_2008 /y""",
        """net stop TrueKeyServiceHelper /y""",
        """net stop sacsvr /y""",
        """net stop VeeamNFSSvc /y""",
        """net stop FA_Scheduler /y""",
        """net stop SAVAdminService /y""",
        """net stop EPUpdateService /y""",
        """net stop VeeamTransportSvc /y""",
        """net stop "Sophos Health Service" /y""",
        """net stop bedbg /y""",
        """net stop MSSQLSERVER /y""",
        """net stop KAVFS /y""",
        """net stop Smcinst /y""",
        """net stop MSSQLServerADHelper100 /y""",
        """net stop TmCCSF /y""",
        """net stop wbengine /y""",
        """net stop SQLWriter /y""",
        """net stop MSSQLFDLauncher$TPS /y""",
        """net stop SmcService /y""",
        """net stop ReportServer$TPSAMA /y""",
        """net stop swi_update /y""",
        """net stop AcrSch2Svc /y""",
        """net stop MSSQL$SYSTEM_BGC /y""",
        """net stop VeeamBrokerSvc /y""",
        """net stop MSSQLFDLauncher$PROFXENGAGEMENT /y""",
        """net stop VeeamDeploymentService /y""",
        """net stop SQLAgent$TPS /y""",
        """net stop DCAgent /y""",
        """net stop "Sophos Message Router" /y""",
        """net stop MSSQLFDLauncher$SBSMONITORING /y""",
        """net stop wbengine /y""",
        """net stop MySQL80 /y""",
        """net stop MSOLAP$SYSTEM_BGC /y""",
        """net stop ReportServer$TPS /y""",
        """net stop MSSQL$ECWDB2 /y""",
        """net stop SntpService /y""",
        """net stop SQLSERVERAGENT /y""",
        """net stop BackupExecManagementService /y""",
        """net stop SMTPSvc /y""",
        """net stop mfefire /y""",
        """net stop BackupExecRPCService /y""",
        """net stop MSSQL$VEEAMSQL2008R2 /y""",
        """net stop klnagent /y""",
        """net stop MSExchangeSA /y""",
        """net stop MSSQLServerADHelper /y""",
        """net stop SQLTELEMETRY /y""",
        """net stop "Sophos Clean Service" /y""",
        """net stop swi_update_64 /y""",
        """net stop "Sophos Web Control Service" /y""",
        """net stop EhttpSrv /y""",
        """net stop POP3Svc /y""",
        """net stop MSOLAP$TPSAMA /y""",
        """net stop McAfeeEngineService /y""",
        """net stop "Veeam Backup Catalog Data Service" /""",
        """net stop MSSQL$SBSMONITORING /y""",
        """net stop ReportServer$SYSTEM_BGC /y""",
        """net stop AcronisAgent /y""",
        """net stop KAVFSGT /y""",
        """net stop BackupExecDeviceMediaService /y""",
        """net stop MySQL57 /y""",
        """net stop McAfeeFrameworkMcAfeeFramework /y""",
        """net stop TrueKey /y""",
        """net stop VeeamMountSvc /y""",
        """net stop MsDtsServer110 /y""",
        """net stop SQLAgent$BKUPEXEC /y""",
        """net stop UI0Detect /y""",
        """net stop ReportServer /y""",
        """net stop SQLTELEMETRY$ECWDB2 /y""",
        """net stop MSSQLFDLauncher$SYSTEM_BGC /y""",
        """net stop MSSQL$BKUPEXEC /y""",
        """net stop SQLAgent$PRACTTICEBGC /y""",
        """net stop MSExchangeSRS /y""",
        """net stop SQLAgent$VEEAMSQL2008R2 /y""",
        """net stop McShield /y""",
        """net stop SepMasterService /y""",
        """net stop "Sophos MCS Client" /y""",
        """net stop VeeamCatalogSvc /y""",
        """net stop SQLAgent$SHAREPOINT /y""",
        """net stop NetMsmqActivator /y""",
        """net stop kavfsslp /y""",
        """net stop tmlisten /y""",
        """net stop ShMonitor /y""",
        """net stop MsDtsServer /y""",
        """net stop SQLAgent$SQL_2008 /y""",
        """net stop SDRSVC /y""",
        """net stop IISAdmin /y""",
        """net stop SQLAgent$PRACTTICEMGT /y""",
        """net stop BackupExecJobEngine /y""",
        """net stop SQLAgent$VEEAMSQL2008R2 /y""",
        """net stop BackupExecAgentBrowser /y""",
        """net stop VeeamHvIntegrationSvc /y""",
        """net stop masvc /y""",
        """net stop W3Svc /y""",
        """net stop "SQLsafe Backup Service" /y""",
        """net stop SQLAgent$CXDB /y""",
        """net stop SQLBrowser /y""",
        """net stop MSSQLFDLauncher$SQL_2008 /y""",
        """net stop VeeamBackupSvc /y""",
        """net stop "Sophos Safestore Service" /y""",
        """net stop svcGenericHost /y""",
        """net stop ntrtscan /y""",
        """net stop SQLAgent$VEEAMSQL2012 /y""",
        """net stop MSExchangeMGMT /y""",
        """net stop SamSs /y""",
        """net stop MSExchangeES /y""",
        """net stop MBAMService /y""",
        """net stop EsgShKernel /y""",
        """net stop ESHASRV /y""",
        """net stop MSSQL$TPSAMA /y""",
        """net stop SQLAgent$CITRIX_METAFRAME /y""",
        """net stop VeeamCloudSvc /y""",
        """net stop "Sophos File Scanner Service" /y""",
        """net stop "Sophos Agent" /y""",
        """net stop MBEndpointAgent /y""",
        """net stop swi_service /y""",
        """net stop MSSQL$PRACTICEMGT /y""",
        """net stop SQLAgent$TPSAMA /y""",
        """net stop McAfeeFramework /y""",
        """net stop "Enterprise Client Service" /y""",
        """net stop SQLAgent$SBSMONITORING /y""",
        """net stop MSSQL$VEEAMSQL2012 /y""",
        """net stop swi_filter /y""",
        """net stop SQLSafeOLRService /y""",
        """net stop BackupExecVSSProvider /y""",
        """net stop VeeamEnterpriseManagerSvc /y""",
        """net stop SQLAgent$SQLEXPRESS /y""",
        """net stop OracleClientCache80 /y""",
        """net stop MSSQL$PROFXENGAGEMENT /y""",
        """net stop IMAP4Svc /y""",
        """net stop ARSM /y""",
        """net stop MSExchangeIS /y""",
        """net stop AVP /y""",
        """net stop MSSQLFDLauncher /y""",
        """net stop MSExchangeMTA /y""",
        """net stop TrueKeyScheduler /y""",
        """net stop MSSQL$SOPHOS /y""",
        """net stop "SQL Backups" /y""",
        """net stop MSSQL$TPS /y""",
        """net stop mfemms /y""",
        """net stop MsDtsServer100 /y""",
        """net stop MSSQL$SHAREPOINT /y""",
        """net stop WRSVC /y""",
        """net stop mfevtp /y""",
        """net stop msftesql$PROD /y""",
        """net stop mozyprobackup /y""",
        """net stop MSSQL$SQL_2008 /y""",
        """net stop SNAC /y""",
        """net stop ReportServer$SQL_2008 /y""",
        """net stop BackupExecAgentAccelerator /y""",
        """net stop MSSQL$SQLEXPRESS /y""",
        """net stop MSSQL$PRACTTICEBGC /y""",
        """net stop VeeamRESTSvc /y""",
        """net stop sophossps /y""",
        """net stop ekrn /y""",
        """net stop MMS /y""",
        """net stop "Sophos MCS Agent" /y""",
        """net stop RESvc /y""",
        """net stop "Acronis VSS Provider" /y""",
        """net stop MSSQL$VEEAMSQL2008R2 /y""",
        """net stop MSSQLFDLauncher$SHAREPOINT /y""",
        """net stop "SQLsafe Filter Service" /y""",
        """net stop MSSQL$PROD /y""",
        """net stop SQLAgent$PROD /y""",
        """net stop MSOLAP$TPS /y""",
        """net stop VeeamDeploySvc /y""",
        """net stop MSSQLServerOLAPService /y"""
    ]
    
    loop $total_process_stopped as $cmd_index {
        step trying_to_stop_process {
            $process.command_line=random($bat_stop_commands)
            action Process.Start
        }
        sleep 3
    }

}

# SEC 3 - CL0p in action: Ransomeware started
# 1. Creates ".CL0p" encrypt files
# 2. Creates Ransomeware notes "CL0pReadMe.txt" / "README_README.txt"
# 3. Deletes the original files 
tactic "Impact"
section CL0p_in_action "Encrypt and delete original files" {
    tag "mitre-attack=T1486"

    $number_of_encrypts=random.int(21,200)
    loop $number_of_encrypts {
        $randomFolder1=random.string(8)
        $randomFolder2=random.string(10)
        $randomFolder3=random.string(12)
        $randomFileName=random.string(16)
        $file_extension=random($files_extension)
        $file.directory="""C:\${randomFolder1}\${randomFolder2}\${randomFolder3}"""
        $file_affected="${randomFileName}${file_extension}"
        $CL0p_agent_cmd=random($CL0p_agents)
        $CL0p_note_file=random($CL0p_notes)
        $CL0p_crypted_ext=random($CL0p_crypt_extensions)
        $file_crypt_name="${file_affected}${CL0p_crypted_ext}"

        step CL0p_encrypt_action_1st {
            $process.parent.command_line="cmd.exe"
            $process.command_line="${CL0p_agent_cmd} runrun"
            action Process.Start
        }
        
        sleep 0.5
        
        step CL0p_encrypt_action_2nd {
            $process.parent.command_line="cmd.exe"
            $process.command_line="${CL0p_agent_cmd} temp.dat"
            action Process.Start
        }
        
        sleep 0.5
        
        step CL0p_encrypt_new_file {
            $file.name=$file_crypt_name
            action File.Create
        }
    
        sleep 0.5
    
        step CL0p_note_file { 
            $file.name=$CL0p_note_file 
            action File.Create
        }
        
        sleep 0.5
        
        step CL0p_delete_file {
            $file.name=$file_affected 
            action File.Delete
        }
        
        sleep 0.5       
    }
}

tactic "Defense Evasion"
section CL0p_registery_delete "Cl0p Deleting - Cleanups" {
        tag "mitre-attack=T1112"

    step process {
        $process.command_line = """C:\Windows\System32\wscript.exe C:\Windows\System32\WScript.exe "C:\Users\user\Desktop\sample.vbs" """
        action Process.Start
    }
    
    step del_registry {
        $registry.key = """HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\ProxyBypass"""
        action Windows.Registry.Delete        
    }
    
    step del_registry {
        $registry.key = """HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\ProxyBypass"""
        action Windows.Registry.Delete        
    }
    
    step del_registry {
        $registry.key = """HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\IntranetName"""
        action Windows.Registry.Delete        
    }
    
    step del_registry {
        $registry.key = """HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\IntranetName"""
        action Windows.Registry.Delete        
    }
    
    
    step file {
        $file.hash.sha256 = "A8569C78AF187D603EECDC5FAEC860458919349EEF51091893B705F466340ECD"
    
        action File.Open
    }
    # Behavior from A8569C78AF187D603EECDC5FAEC860458919349EEF51091893B705F466340ECD
    step process {
        $process.command_line = """rundll32.exe"""
        action Process.Start
    }

    step make_event {
        $event_id = 1102
        run WinXMLEventlog
    }
}



#
# End of first part
#

#################################
#    Indicators Of Compromise   #
#################################

section indicators "__hidden__" {
    $code64_list=[
        "bb0f1d04c298d0e8025e7293c6669457043a6bce728a19cf58c00d2a278713d0",
        "ec032e15ee695db2ecaf3dbc953cd337b6eb3804cc18a4c56ea6a2be58015357",
        "3f11fe2c0e7438419db918be8309e09ebefd0ef537006e286c788f9c83cb0229",
        "5dd5503545c0cfd5f18b281228b1498e1820130d1510ae277032774bdc61f1e3",
        "2f5a3f784f17055140b85aa8a4ffd995fbcc5b943ae048c104cf032b3379c753",
        "3c537dc628e43f569729c237bc462399dc92d0c6399d7a2d5b52783861cdbc33",
        "8004b2636140efd5677a41e17a8495841d39fb1825da53f3911872f6d4a4d247",
        "389e03b1a1fd1c527d48df74d3c26a0483a5b105f36841193172f1ee80e62c1b",
        "94b76ce34e5493bb59586b41f41b23baa07a55f2397e80775573714b1311103c",
        "b5b60a7e8fe966de0600439882ea8b5548296ca0b12b196f3932ceb96b5e4ed6",
        "821b30b668d8a97d4a149ae13967ddb407170182a3d6b7caa92767a97dd51b8d",
        "ee83fd9b8368bd4d2cdbebdccfdb41373c3c490d9c5b8d17530990e084131f29",
        "aaa4f5bb1bd81db677b21938b03b0cd282c200a9cd0d82ef85c83805c9e8e66f",
        "0e3fd4f37b395b9177ccec786f339dd2dc3a539f69b49ac41e55ca21ead7fe73",
        "e7f17df3e41c7ac23d3b979a4dd8e92bdf12e08e8dd064bd8614a415322dc639",
        "d2e67b793cee2f415276ff9afb5bf9d9d497cc080699b901a29b8588a5abbba8",
        "8a3a83a10ec5aa9ed6f3bdc3d0c941bed6015ee4edc28e8a8288195d93e2a775",
        "2f29950640d024779134334cad79e2013871afa08c7be94356694db12ee437e2",
        "31829479fa5b094ca3cfd0222e61295fff4821b778e5a7bd228b0c31f8a3cc44",
        "e48900dc697582db4655569bb844602ced3ad2b10b507223912048f1f3039ac6",
        "00e815ade8f3ad89a7726da8edd168df13f96ccb6c3daaf995aa9428bfb9ecf1",
        "c150954e5fdfc100fbb74258cad6ef2595c239c105ff216b1d9a759c0104be04",
        "7ada1228c791de703e2a51b1498bc955f14433f65d33342753fdb81bb35e5886",
        "3320f11728458d01eef62e10e48897ec1c2277c1fe1aa2d471a16b4dccfc1207",
        "0d19f60423cb2128555e831dc340152f9588c99f3e47d64f0bb4206a6213d579",
        "408af0af7419f67d396f754f01d4757ea89355ad19f71942f8d44c0d5515eec8",
        "bc59ff12f71e9c8234c5e335d48f308207f6accfad3e953f447e7de1504e57af",
        "35b0b54d13f50571239732421818c682fbe83075a4a961b20a7570610348aecc",
        "8e1bbe4cedeb7c334fe780ab3fb589fe30ed976153618ac3402a5edff1b17d64",
        "d0cde86d47219e9c56b717f55dcdb01b0566344c13aa671613598cab427345b9"
    ]

    # Decryption is a simple XOR operation with bytes from these strings
    $decryption_xor_strings=[
        "Po39NHfwik237690t34nkjhgbCL0pfdewquitr362DSRdqpnmbvzjkhgFD231ed76tgfvFAHGVSDqhjwgdyucvsbCdigr1326dvsaghjvehjGJHGHVdbas",
        "JLKHFVIjewhyur3ikjfldskfkl23j3iuhdnfklqhrjjio2ljkeosfjh7823763647823hrfuweg56t7r6t73824y78CL0p"
    ]

    $known_hashes=[
        "ed7db8c2256b2d5f36b3d9c349a6ed0b"
    ]

    $files_affected=[
        "CL0pReadMe.txt",
        "README_README.txt",
        "ntldr",
        "NTDLR",
        "boot.ini",
        "BOOT.INI",
        "ntuser.ini",
        "NTUSER.INI",
        "AUTOEXEC.BAT",
        "autoexec.bat",
        "NTDETECT.COM",
        "ntdetect.com",
        "desktop.ini",
        "autorun.inf",
        "ntuser.dat",
        "iconcache.db",
        "bootsect.bak",
        "ntuser.dat.log",
        "thumbs.db",
        "DESKTOP.INI",
        "AUTORUN.INF",
        "NTUSER.DAT",
        "ICONCACHE.DB",
        "BOOTSECT.BAK",
        "NTUSER.DATA.LOG",
        "THUMBS.DB"
    ]

    $extensions_affected=[
        ".CL0p",
        ".Cllp",
        ".dll",
        ".DLL",
        ".exe",
        ".EXE",
        ".sys",
        ".SYS",
        ".ocx",
        ".OCX",
        ".LNK",
        ".lnk"
    ]
    $bat_header_commands=[
        """@echo of""",
        """vssadmin Delete Shadows /all /quiet""",
        """vssadmin resize shadowstorage /for=c: /on=c: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=c: /on=c: /maxsize=unbounded""",
        """vssadmin resize shadowstorage /for=d: /on=d: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=d: /on=d: /maxsize=unbounded""",
        """vssadmin resize shadowstorage /for=e: /on=e: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=e: /on=e: /maxsize=unbounded""",
        """vssadmin resize shadowstorage /for=f: /on=f: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=f: /on=f: /maxsize=unbounded""",
        """vssadmin resize shadowstorage /for=g: /on=g: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=g: /on=g: /maxsize=unbounded""",
        """vssadmin resize shadowstorage /for=h: /on=h: /maxsize=401MB""",
        """vssadmin resize shadowstorage /for=h: /on=h: /maxsize=unbounded""",
        """bcdedit /set {default} recoveryenabled No""",
        """bcdedit /set {default} bootstatuspolicy ignoreallfailures""",
        """vssadmin Delete Shadows /all /quiet"""
    ]

}
# # From Splunk
# # # Resize ShadowStorage volume
# # reference "https://research.splunk.com/endpoint/bc760ca6-8336-11eb-bcbb-acde48001122/"

    $parent_processes = ["cmd.exe", "powershell.exe", "powershell_ise.exe", "wmic.exe"]

    step start_process {
        $process.parent.command_line = random($parent_processes)
        $process.command_line = "vssadmin.exe resize shadowstorage /maxsize "
        action Process.Start 
    }

# # Windows Service Created with Suspicious Service Path
    $user.name = "Jean.Neymard"

    step service_install {
        $ServiceName = "Cleaner program"
        $ImagePath = "C:\\Users\\${user.name}\\evil.exe"
        action Service.Install
    }

# # Windows Event Log Cleared

    step make_event {
        $event_id = 1102
        run WinXMLEventlog
    }

# # Suspicious wevtutil Usage
    $process_arguments_1 = [" cl "," clear-log"]
    $process_arguments_2 = ["System","Security","Setup","Application","trace"]
    $arg1 = random($process_arguments_1)
    $arg2 = random($process_arguments_2)

    step process_start {
        $process.command_line = "wevtutil.exe ${arg1} ${arg2} "
        action Process.Start
    }

# # Suspicious Event Log Service Behavior
    step winevent_1100 {
        $event_id = 1100
        run WinXMLEventlog
    }

# # Ransomware Notes bulk creation
    $extensions = ["txt", "html", "hta"]
    $ext = random($extensions)
    $random_name = random.string(10)
    $process.command_line="c:\\Users\Alfred\\cl0p.exe"

loop 15 {
    step file_create {
        $random_path = random.string(5)
        $file.name = "C:\\${random_path}\\${random_name}.${ext}"
        action File.Create
    }
}


# # Process Deleting Its Process File Path
    step delete_itself {
        $process.command_line = "C:\\Windows\\System32\\cmd.exe /c del "
        $process.parent.command_line = $process.command_line
        action Process.Start
    }

# # High Process Termination Frequency
#loop 15 {
    step process_stop {
        $process.command_line = random.string(21)
        action Process.Stop
    }
#}

# # Common Ransomware Notes
    $ransomware_notes = ["HELP_TO_SAVE_FILES.txt",
    "BitCryptorFileList.txt",
    "BUYUNLOCKCODE",
    "YOUR_FILES_ARE_ENCRYPTED.HTML",
    "Coin.Locker.txt",
    "DECRYPT_INSTRUCTIONS.HTML",
    "ReadDecryptFilesHere.txt",
    "HOW_DECRYPT.TXT",
    "READ IF YOU WANT YOUR FILES BACK.HTML",
    "GetYouFiles.txt",
    "HOW TO DECRYPT FILES.HTML",
    "DECRYPT_INSTRUCTION.TXT",
    "HELP_DECRYPT.TXT",
    "HELP_YOURFILES.HTML",
    "HowDecrypt.gif",
    "Decrypt All Files *.bmp",
    "cryptinfo.txt",
    "DECRYPT_Readme.TXT.ReadMe",
    "qwer.html",
    "qwer2.html",
    "Hellothere.txt",
    "FILESAREGONE.TXT",
    "HOW TO DECRYPT FILES.TXT",
    "DECRYPT_Readme.TXT.ReadMe",
    "README_DECRYPT_HYDRA_ID_*.txt",
    "DECRYPT_YOUR_FILES.HTML",
    "KryptoLocker_README.txt",
    "_Locky_recover_instructions.txt",
    "DECRYPT_Readme.TXT.ReadMe",
    "ATTENTION.RTF",
    "how to get data.txt",
    "IMPORTANT READ ME.txt",
    "UnblockFiles.vbs",
    "YOUR_FILES.url",
    "exit.hhr.obleep",
    "HOW_TO_DECRYPT.HTML",
    "HOW-TO-DECRYPT-FILES.HTML",
    "HELP_TO_SAVE_FILES.txt",
    "HELP_TO_SAVE_FILES.txt",
    "HELP_TO_SAVE_FILES.txt",
    "_H_e_l_p_RECOVER_INSTRUCTIONS+*.txt",
    "DECRYPT_INSTRUCTIONS.HTML",
    "README_DECRYPT_UMBRE_ID_*.txt",
    "Help_Decrypt.txt",
    "CryptLogFile.txt",
    "*@Please_Read_Me@.txt*",
    "*@WanaDecryptor@.exe*",
    "# DECRYPT MY FILES #.vbs",
    "# DECRYPT MY FILES #.html",
    "# DECRYPT MY FILES #.txt",
    "# DECRYPT MY FILES #.vbs",
    "# DECRYPT MY FILES #.html",
    "# DECRYPT MY FILES #.txt",
    "HELP_DECRYPT_YOUR_FILES.HTML",
    "*-HELP_FOR_DECRYPT_FILE.html",
    "*-SORRY-FOR-FILES.html",
    "*-READ-FOR-HELLPP.html",
    "RyukReadMe.html",
    "ClopReadMe.txt",
    "README_README.txt",
    "JSWORM-DECRYPT.html",
    "NEMTY_*-DECRYPT.txt",
    "NEFILIM-DECRYPT.txt",
    "OFFWHITE-MANUAL.txt",
    "TELEGRAM-RECOVER.txt",
    "FUSION-README.txt",
    "MILIHPEN-INSTRUCT.txt",
    "GANGBANG-NOTE.txt",
    "GET_YOUR_FILES_BACK.txt",
    "read_it.txt",
    "*.README.txt",
    "*READ_ME_MEDUSA*.TXT",
    "How_to_back_files.HTML"]

    step ransomware_notes {
        $picked_file = random($ransomware_notes)
        $random_str = random.string(1)
        $file.name = string.replace($picked_file, "*", $random_str)
        action File.Create
    }

# # Common Ransomware Extensions

    $ransomware_extensions = [".enc",".777",".R4A",".R5A",".7h9r",".8lock8",".encrypt",".amba",
    ".adk",".encrypted",".SecureCrypted",".FuckYourData",".unavailable",".bleepYourFiles",
    ".Where_my_files.txt",".encrypted",".locked",".locky",".adr",".avos",".avos2",
    ".avoslinux",".bart.zip",".bart",".perl",".clf",".bitstak",".Silent",".blocatto",
    ".cry",".cerber",".cerber2",".cerber3",".clf",".coverton",".enigma",".czvxce",
    ".criptiko",".criptoko",".criptokod",".cripttt",".aga",".cry",".ENCRYPTED",
    ".crypt38",".scl",".crinf",".frtrss",".clf",".crjoker",".encrypted ",".ENC",".code",
    ".scl",".crptrgr",".locked",".CryptoTorLocker2015!",".crypt",".crypt",".crypt",".cryp1",
    ".crypz",".cryptz",".cryp1",".ctbl",".encrypted",".ded",".domino",".locked",".isis",
    ".locked",".ha3",".enigma",".1txt",".exotic",".locked",".fantom",".Z81928819",".purge",
    ".globe",".locked",".crypt",".herbst",".cry",".locky",".crime",".crime",".btc",".kkk",
    ".fun",".gws",".porno",".payransom",".payms",".paymst",".AFD",".paybtcs",".epic",".xyz",
    ".locked",".encrypted",".keybtc@inbox_com",".rip",".kimcilware",".locked",".kostya",
    ".kratos",".LeChiffre",".locky",".zepto",".odin",".shit",".thor",".asier",".zzzzz",
    ".osiris",".lock93",".crime",".oor",".magic",".Lock",".fucked",".fuck",".locked",
    ".KEYZ",".KEYH0LES",".crypted",".odcodc",".cbf",".LOL!",".OMG!",".padcrypt",".locked",
    ".locked",".filock",".locky",".crypt",".locked",".RDM",".RRK",".RAD",".RADAMANT",
    ".locked",".kraken",".darkness",".nochance",".oshit",".oplata@qq_com",".relock@qq_com",
    ".crypto",".helpdecrypt@ukr.net",".pizda@qq_com",".dyatel@qq_com","._ryp",
    ".nalog@qq_com",".chifrator@qq_com",".gruzin@qq_com",".troyancoder@qq_com",
    ".encrypted",".cry",".AES256",".enc",".hb15",".vscrypt",".infected",".bloc",
    ".korrektor",".rekt",".remind",".crashed",".rokku",".encryptedAES",".encryptedRSA",
    ".encedRSA",".justbtcwillhelpyou",".btcbtcbtc",".btc-help-you",".only-we_can-help_you",
    ".iwanthelpuuu",".notfoundrans",".encmywork",".weapologize",".stubbin",".areyoulovemyrans",
    ".loveransisgood",".myransext2017",".disposed2017",".prosperous666",".supported2017",
    ".country82000",".moments2900",".breeding123",".mention9823",".suppose666",".skjdthghh",
    ".cifgksaffsfyghd",".iaufkakfhsaraf",".filegofprencrp",".weencedufiles",
    ".encryptedyourfiles",".letmetrydecfiles",".otherinformation",".weareyourfriends",
    ".noproblemwedecfiles",".powerfulldecrypt",".wowreadfordecryp",".wowwhereismyfiles",
    ".helpmeencedfiles",".theworldisyours",".vekanhelpu",".howcanihelpusir",".VforVendetta",
    ".checkdiskenced",".goforhelp",".iloveworld",".canihelpyou",".AreYouLoveMyRansFile",
    ".fucku",".happenencedfiles",".iwishiyou",".powerfulldecryp",".suppose665",
    ".Whereisyourfiles",".sanction",".locked",".shino",".locked",".encrypted",".RSNSlocked",
    ".RSplited",".sport",".locked",".locked",".surprise",".tzu",".szf",".xcri",".vvv",".ecc",
    ".exx",".ezz",".abc",".aaa",".zzz",".xyz",".micro",".xxx",".ttt",".mp3",".Encrypted",
    ".enc",".toxcrypt",".better_call_saul",".xtbl",".da_vinci_code",".windows10",".enc",
    ".locked",".H3LL",".0x0",".1999",".CRRRT",".CCCRRRPPP",".vault",".xort",".trun",
    ".Venusf",".Venusp",".CrySiS",".xtbl",".wflx",".EnCiPhErEd",".73i87A",".p5tkjw",
    ".PoAr2w",".fileiscryptedhard",".encoderpass",".zc3791",".xrtn",".zcrypt",".crypto",
    ".vault",".zyklon",".wncry",".wcry",".wnry",".wncryt",".WNCRYT",".RYK",".Clop",".Cllp",
    ".JSWORM",".NEMTY_*",".NEFILIM",".OFFWHITE",".TELEGRAM",".FUSION",".MILIHPEN",".GANGBANG",
    ".reddot",".MEDUSA",".rhysida"]

# loop 21 {
    step file_create {
        $ranfile = random.string(10)
        $ranext = random($ransomware_extensions)
        $file.name = "C:\\Users\\Tom\\${ranfile}${ranext}"
        action File.Create
    }


# # Clop Ransomware Known Service Name

        $services = ["SecurityCenterIBM", "WinCheckDRVs"]   
        $service = random($services)

    step install_service {
        $service.name = $service
        action Service.Install
    }

# # Clop Common Exec Parameter
        $processes = ["runrun", "temp.dat"]
        $prefix = random.string(5)
        $suffix = random.string(5)
        $process = random($processes)

    step run_process {
        $process.command_line = "${prefix}${process}${suffix}"
        action Process.Start
    }

section deleting_various_files {
    $file_extensions = [".cmd", ".ini",".gif", ".jpg", ".jpeg", ".db", ".ps1", ".doc", ".xls", ".ppt", ".bmp",".zip", ".rar", ".7z", ".chm", ".png", ".log", ".vbs", ".js", ".vhd", ".bak", ".wbcat", ".bkf" , ".backup", ".dsk", ".win"]

    loop 100 {
        step delete_file {
            $file_prefix = random.string(10)
            $file_ext = random($file_extensions)
            $file.name = "${file_prefix}${file_ext}"
            action File.Delete
        }
    }
}

section analytic_story "__hidden__" {
# Clop Ransomware Known Service Name
$services = ["SecurityCenterIBM", "WinCheckDRVs"]
$service = random($services)

    step install_service {
        $service.name = $service
        action Service.Install
    }
}

section end "End" {}

